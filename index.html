fetch('https://raw.githubusercontent.com/AriAb247/Ariab247.github.io/main/Allocations_sheet.csv')
  .then(response => response.text())
  .then(csv => {
    const data = Papa.parse(csv, { header: true }).data;

    // Create an array of unique specialities, sort alphabetically
    const specialities = [...new Set(data.map(d => d.speciality))].sort();

    // Add score drop-downs to the DOM
    const scoreContainer = document.getElementById('score');
    for (let i = 0; i < specialities.length; i++) {
      const speciality = specialities[i];
      const scoreEl = document.createElement('div');
      scoreEl.innerHTML = `${speciality}: `;
      const scoreDropdown = document.createElement('select');
      scoreDropdown.setAttribute('data-speciality', speciality);
      scoreDropdown.addEventListener('change', () => {
        // Store the score in local storage
        const scores = JSON.parse(localStorage.getItem('scores')) || {};
        scores[speciality] = scoreDropdown.value;
        localStorage.setItem('scores', JSON.stringify(scores));

        // Update the UI
        updateScores();
      });
      for (let j = -10; j <= 10; j++) {
        const option = document.createElement('option');
        option.value = j;
        option.text = j;
        scoreDropdown.appendChild(option);
      }
      scoreEl.appendChild(scoreDropdown);
      scoreContainer.appendChild(scoreEl);
    }

    // Create an array of unique locations, sort alphabetically
    const locations = [...new Set(data.map(d => d.location))].sort();

    // Add location score drop-downs to the DOM
    const locationScoreContainer = document.getElementById('location-score');
    for (let i = 0; i < locations.length; i++) {
      const location = locations[i];
      const locationScoreEl = document.createElement('div');
      locationScoreEl.innerHTML = `${location}: `;
      const locationScoreDropdown = document.createElement('select');
      locationScoreDropdown.setAttribute('data-location', location);
      locationScoreDropdown.addEventListener('change', () => {
        // Store the location score in local storage
        const locationScores = JSON.parse(localStorage.getItem('locationScores')) || {};
        locationScores[location] = locationScoreDropdown.value;
        localStorage.setItem('locationScores', JSON.stringify(locationScores));

        // Update the UI
        updateLocationScores();
      });
      for (let j = -10; j <= 10; j++) {
        const option = document.createElement('option');
        option.value = j;
        option.text = j;
        locationScoreDropdown.appendChild(option);
      }
      locationScoreEl.appendChild(locationScoreDropdown);
      locationScoreContainer.appendChild(locationScoreEl);
    }

    // Retrieve scores from local storage and update the UI
    function updateScores() {
      const scores = JSON.parse(localStorage.getItem('scores')) || {};
      for (let i = 0; i < specialities.length; i++) {
        const speciality = specialities[i];
        const scoreDropdown = document.querySelector(`[data-speciality="${speciality}"]`);
        const score = scores[speciality] || 0;
        scoreDropdown.value = score;
      }
    }

    // Retrieve location scores from local storage and update the UI
    function updateLocationScores() {
      const locationScores = JSON.parse(localStorage.getItem('locationScores')) || {};
      for (let i = 0; i < locations.length; i++) {
        const location = locations[i];
        const locationDropdown = document.querySelector(`[data-location="${location}"]`);
        const score = locationScores[location] || 0;
        locationDropdown.value = score;
      }
    }
  document.getElementById('update-button').addEventListener('click', () => {
  updateTotalScores();
});

// Group rows by program title and add them to the allocation table
const groupedData = data.reduce((acc, row) => {
  if (!acc[row.programmeTitle]) {
    acc[row.programmeTitle] = [];
  }
  acc[row.programmeTitle].push(row);
  return acc;
}, {});

const table = document.getElementById('allocation-table');
let tableHTML = `
  <thead>
    <tr>
      <th>Programme Title</th>
      <th>Speciality</th>
      <th>Location</th>
      <th>Placement Order</th>
      <th>Total Score</th>
    </tr>
  </thead>
  <tbody>
`;

function updateTotalScores() {
  const tableBody = table.getElementsByTagName('tbody')[0];
  const rows = tableBody.getElementsByTagName('tr');

  for (const programmeTitle in groupedData) {
    const programmeRows = groupedData[programmeTitle];
    let totalScore = 0;

    for (let i = 0; i < programmeRows.length; i++) {
      const row = programmeRows[i];
      const speciality = row.speciality;
      const location = row.location;

      const scores = JSON.parse(localStorage.getItem('scores')) || {};
      const locationScores = JSON.parse(localStorage.getItem('locationScores')) || {};
      const specialityScore = parseInt(scores[speciality]) || 0;
      const locationScore = parseInt(locationScores[location]) || 0;
      const specialityWeight = parseFloat(document.getElementById('speciality-weight').value) || 0;
      const locationWeight = parseFloat(document.getElementById('location-weight').value) || 0;

      totalScore += specialityScore * specialityWeight + locationScore * locationWeight;
    }
   

    for (let i = 0; i < rows.length; i++) {
      const tableRow = rows[i];
      const programmeCell = tableRow.cells[0];

      if (programmeCell.textContent === programmeTitle) {
        if (tableRow.cells.length === 5) { // Check if the row has a total score cell
          tableRow.cells[4].textContent = totalScore;
        } else {
          const totalScoreCell = document.createElement('td');
          totalScoreCell.textContent = totalScore;
          tableRow.appendChild(totalScoreCell);
        }
        break;
      }
    }
  }
}
  

// Update the UI
      updateTableHTML();
    }

    function updateTableHTML() {
      for (const programmeTitle in groupedData) {
        const rows = groupedData[programmeTitle];
        
        // Calculate total scores and store them in the rows
        rows.forEach(row => {
          const speciality = row.speciality;
          const location = row.location;
          const scores = JSON.parse(localStorage.getItem('scores')) || {};
          const locationScores = JSON.parse(localStorage.getItem('locationScores')) || {};
          const specialityScore = parseInt(scores[speciality]) || 0;
          const locationScore = parseInt(locationScores[location]) || 0;
          const specialityWeight = parseFloat(document.getElementById('speciality-weight').value) || 0;
          const locationWeight = parseFloat(document.getElementById('location-weight').value) || 0;
          const totalScore = specialityScore * specialityWeight + locationScore * locationWeight;

          row.totalScore = totalScore;
        });

        // Sort rows by their total score
        rows.sort((a, b) => b.totalScore - a.totalScore);
      }

      // Generate the tableHTML string
      let tableHTML = `
        <thead>
          <tr>
            <th>Programme Title</th>
            <th>Speciality</th>
            <th>Location</th>
            <th>Placement Order</th>
            <th>Total Score</th>
          </tr>
        </thead>
        <tbody>
      `;
      
      for (const programmeTitle in groupedData) {
        const rows = groupedData[programmeTitle];
        rows.forEach((row, index) => {
          tableHTML += `
            <tr>
              ${index === 0 ? `<td rowspan="${rows.length}">${programmeTitle}</td>` : ''}
              <td>${row.speciality}</td>
              <td>${row.location}</td>
              <td>${row.placementOrder}</td>
              ${index === 0 ? `<td rowspan="${rows.length}" class="total-score">${row.totalScore}</td>` : ''}
            </tr>
          `;
        });
      }

      tableHTML += '</tbody>';
      table.innerHTML = tableHTML;
    }

    // Initialize the UI
    updateScores();
    updateLocationScores();
    updateTotalScores();
  });

</script>
</body>
</html>
